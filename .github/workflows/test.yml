name: Test Fork
on:
  schedule:
    # To decrease chances of delay, workflow is scheduled 15 mins
    # past midnight every day. See: https://docs.github.com/en/actions/reference/workflows-and-actions/events-that-trigger-workflows#schedule
    # * is a special character in YAML so you have to quote this string
    - cron: "15 0 * * *" # 15 minutes past midnight daily
  workflow_dispatch:

jobs:
  hive-integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fre up disk space
        run: |
          echo "=============================================================================="
          echo "Freeing up disk space on CI system"
          echo "=============================================================================="
          df -h
          echo "Removing large directories"

          # Remove Java (JDKs)
          sudo rm -rf /usr/lib/jvm

          # Remove .NET SDKs
          sudo rm -rf /usr/share/dotnet

          # Remove Swift toolchain
          sudo rm -rf /usr/share/swift

          # Remove Haskell (GHC)
          sudo rm -rf /usr/local/.ghcup

          # Remove Julia
          sudo rm -rf /usr/local/julia*

          # Remove Android SDKs
          sudo rm -rf /usr/local/lib/android

          # Remove Chromium (optional if not using for browser tests)
          sudo rm -rf /usr/local/share/chromium

          # Remove Microsoft/Edge and Google Chrome builds
          sudo rm -rf /opt/microsoft /opt/google

          # Remove Azure CLI
          sudo rm -rf /opt/az

          # Remove PowerShell
          sudo rm -rf /usr/local/share/powershell

          # Remove CodeQL and other toolcaches
          sudo rm -rf /opt/hostedtoolcache

          docker system prune -af || true
          docker builder prune -af || true
          sudo apt-get remove -y azure-cli google-cloud-sdk hhvm google-chrome-stable firefox powershell mono-devel || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: Install Node.js dependencies
        run: npm ci

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Install Hive CLI
        run: |
          echo "ðŸ”„ Installing Hive CLI..."
          git clone https://github.com/ethereum/hive.git /tmp/hive
          cd /tmp/hive
          go build .
          echo "âœ… Hive CLI installed"

          ./hive --cleanup || echo "Warning: Hive CLI may not be properly installed"

      - name: Run integration tests
        env:
          HIVE_AMSTERDAM_TIMESTAMP: 1759250952
        run: |
          echo "ðŸš€ Running Hive integration tests..."
          npm run test
          echo "âœ… Integration tests completed"

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet src/data/forks/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ No changes detected in test results"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Changes detected in test results"
          fi

      - name: Commit and push results
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add src/data/forks/

          git commit -m "ðŸš¥ ci: Test results updated"

          git push

          echo "âœ… Test results committed and pushed"
